name: CICD

env:
  PYTHON_VERSION: "3.8"
  GO_VERSION: "1.18"

on:
  push:
  pull_request:

jobs:
  lint:
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout source
        uses: actions/checkout@v3
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      - name: Setup Python test prerequisites
        run: |
          ./do.sh prepytest
      - name: Lint Python Code
        run: |
          ./do.sh pylint
      - name: Setup Go
        uses: actions/setup-go@v3
        with:
          go-version: ${{ env.GO_VERSION }}
      - name: Setup Go test prerequisites
        run: |
          ./do.sh pregotest
      - name: Lint Go Code
        run: |
          ./do.sh golint

  examples_py:
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout source
        uses: actions/checkout@v3
      - name: Setup docker
        uses: docker-practice/actions-setup-docker@master
      - name: Deploy back-to-back CP/DP distribution of ixia-c
        run: |
          ./do.sh topo new cpdp
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      - name: Setup test prerequisites
        run: |
          ./do.sh prepytest
      - name: Run Python example tests
        run: |
          ./do.sh pytest -m example
      - name: Get container logs
        if: always()
        run: |
          ./do.sh topo logs
      - name: Archive logs
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: examples_py
          path: |
            logs
      - name: Teardown back-to-back CP/DP distribution of ixia-c
        run: |
          ./do.sh topo rm cpdp

  examples_go:
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout source
        uses: actions/checkout@v3
      - name: Setup docker
        uses: docker-practice/actions-setup-docker@master
      - name: Deploy back-to-back CP/DP distribution of ixia-c
        run: |
          ./do.sh topo new cpdp
      - name: Setup Go
        uses: actions/setup-go@v3
        with:
          go-version: ${{ env.GO_VERSION }}
      - name: Setup test prerequisites
        run: |
          ./do.sh pregotest
      - name: Run Go example tests
        run: |
          ./do.sh gotest -tags example
      - name: Get container logs
        if: always()
        run: |
          ./do.sh topo logs
      - name: Archive logs
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: examples_go
          path: |
            logs
      - name: Teardown back-to-back CP/DP distribution of ixia-c
        run: |
          ./do.sh topo rm cpdp

  dp_py:
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout source
        uses: actions/checkout@v3
      - name: Setup docker
        uses: docker-practice/actions-setup-docker@master
      - name: Deploy back-to-back DP-only distribution of ixia-c
        run: |
          ./do.sh topo new dp
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      - name: Setup test prerequisites
        run: |
          ./do.sh prepytest
      - name: Run Python DP-only tests
        run: |
          ./do.sh pytest -m dp_feature
      - name: Get container logs
        if: always()
        run: |
          ./do.sh topo logs
      - name: Archive logs
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: dp_py
          path: |
            logs
      - name: Teardown back-to-back DP-only distribution of ixia-c
        run: |
          ./do.sh topo rm dp

  dp_go:
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout source
        uses: actions/checkout@v3
      - name: Setup docker
        uses: docker-practice/actions-setup-docker@master
      - name: Deploy back-to-back DP-only distribution of ixia-c
        run: |
          ./do.sh topo new dp
      - name: Setup Go
        uses: actions/setup-go@v3
        with:
          go-version: ${{ env.GO_VERSION }}
      - name: Setup test prerequisites
        run: |
          ./do.sh pregotest
      - name: Run Go DP-only tests
        run: |
          ./do.sh gotest -tags="dp_feature"
      - name: Get container logs
        if: always()
        run: |
          ./do.sh topo logs
      - name: Archive logs
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: dp_go
          path: |
            logs
      - name: Teardown back-to-back DP-only distribution of ixia-c
        run: |
          ./do.sh topo rm dp

  cpdp_py:
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout source
        uses: actions/checkout@v3
      - name: Setup docker
        uses: docker-practice/actions-setup-docker@master
      - name: Deploy back-to-back CP/DP distribution of ixia-c
        run: |
          GITHUB_USER=${{ secrets.ENV_GITHUB_USER }} GITHUB_PAT=${{ secrets.ENV_GITHUB_PAT }} ./do.sh topo new cpdp
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      - name: Setup test prerequisites
        run: |
          ./do.sh prepytest
      - name: Run Python tests
        run: |
          ./do.sh pytest -m feature
      - name: Get container logs
        if: always()
        run: |
          ./do.sh topo logs cpdp
      - name: Archive logs
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: cpdp_py
          path: |
            logs
      - name: Teardown back-to-back CP/DP distribution of ixia-c
        run: |
          ./do.sh topo rm cpdp

  cpdp_go:
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout source
        uses: actions/checkout@v3
      - name: Setup docker
        uses: docker-practice/actions-setup-docker@master
      - name: Deploy back-to-back CP/DP distribution of ixia-c
        run: |
          GITHUB_USER=${{ secrets.ENV_GITHUB_USER }} GITHUB_PAT=${{ secrets.ENV_GITHUB_PAT }} ./do.sh topo new cpdp
      - name: Setup Go
        uses: actions/setup-go@v3
        with:
          go-version: ${{ env.GO_VERSION }}
      - name: Setup test prerequisites
        run: |
          ./do.sh pregotest
      - name: Run Go tests
        run: |
          ./do.sh gotest -tags="feature"
      - name: Get container logs
        if: always()
        run: |
          ./do.sh topo logs cpdp
      - name: Archive logs
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: cpdp_go
          path: |
            logs
      - name: Teardown back-to-back CP/DP distribution of ixia-c
        run: |
          ./do.sh topo rm cpdp

  cpdp_ipv6_py:
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout source
        uses: actions/checkout@v3
      - name: Setup docker
        uses: docker-practice/actions-setup-docker@master
      - name: Deploy back-to-back CP/DP distribution of ixia-c
        run: |
          GITHUB_USER=${{ secrets.ENV_GITHUB_USER }} GITHUB_PAT=${{ secrets.ENV_GITHUB_PAT }} ./do.sh topo new cpdp ipv6
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      - name: Setup test prerequisites
        run: |
          ./do.sh prepytest
      - name: Run Python tests
        run: |
          ./do.sh pytest -m feature
      - name: Get container logs
        if: always()
        run: |
          ./do.sh topo logs cpdp
      - name: Archive logs
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: cpdp_ipv6_py
          path: |
            logs
      - name: Teardown back-to-back CP/DP distribution of ixia-c
        run: |
          ./do.sh topo rm cpdp

  cpdp_ipv6_go:
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout source
        uses: actions/checkout@v3
      - name: Setup docker
        uses: docker-practice/actions-setup-docker@master
      - name: Deploy back-to-back CP/DP distribution of ixia-c
        run: |
          GITHUB_USER=${{ secrets.ENV_GITHUB_USER }} GITHUB_PAT=${{ secrets.ENV_GITHUB_PAT }} ./do.sh topo new cpdp ipv6
      - name: Setup Go
        uses: actions/setup-go@v3
        with:
          go-version: ${{ env.GO_VERSION }}
      - name: Setup test prerequisites
        run: |
          ./do.sh pregotest
      - name: Run Go tests
        run: |
          ./do.sh gotest -tags="feature"
      - name: Get container logs
        if: always()
        run: |
          ./do.sh topo logs cpdp
      - name: Archive logs
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: cpdp_ipv6_go
          path: |
            logs
      - name: Teardown back-to-back CP/DP distribution of ixia-c
        run: |
          ./do.sh topo rm cpdp

  kne_b2b_py:
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout source
        uses: actions/checkout@v3
      - name: Setup docker
        uses: docker-practice/actions-setup-docker@master
      - name: Setup Go
        uses: actions/setup-go@v3
        with:
          go-version: ${{ env.GO_VERSION }}
      - name: Setup KNE cluster
        run: |
          GITHUB_USER=${{ secrets.ENV_GITHUB_USER }} GITHUB_PAT=${{ secrets.ENV_GITHUB_PAT }} ./do.sh new_k8s_cluster kne
      - name: Deploy KNE OTG back-to-back topology
        run: |
          GITHUB_USER=${{ secrets.ENV_GITHUB_USER }} GITHUB_PAT=${{ secrets.ENV_GITHUB_PAT }} ./do.sh topo new kneb2b
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      - name: Setup test prerequisites
        run: |
          ./do.sh prepytest
      - name: Run Python tests
        run: |
          ./do.sh pytest -m feature
      - name: Archive logs
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: kne_b2b_py
          path: |
            logs
      - name: Teardown KNE OTG back-to-back topology
        run: |
          ./do.sh topo rm kneb2b

  kne_b2b_go:
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout source
        uses: actions/checkout@v3
      - name: Setup docker
        uses: docker-practice/actions-setup-docker@master
      - name: Setup Go
        uses: actions/setup-go@v3
        with:
          go-version: ${{ env.GO_VERSION }}
      - name: Setup KNE cluster
        run: |
          GITHUB_USER=${{ secrets.ENV_GITHUB_USER }} GITHUB_PAT=${{ secrets.ENV_GITHUB_PAT }} ./do.sh new_k8s_cluster kne
      - name: Deploy KNE OTG back-to-back topology
        run: |
          GITHUB_USER=${{ secrets.ENV_GITHUB_USER }} GITHUB_PAT=${{ secrets.ENV_GITHUB_PAT }} ./do.sh topo new kneb2b
      - name: Setup test prerequisites
        run: |
          ./do.sh pregotest
      - name: Run Go tests
        run: |
          ./do.sh gotest -tags="feature"
      - name: Archive logs
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: kne_b2b_go
          path: |
            logs
      - name: Teardown KNE OTG back-to-back topology
        run: |
          ./do.sh topo rm kneb2b

  kne_b2b_eth0:
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout source
        uses: actions/checkout@v3
      - name: Setup docker
        uses: docker-practice/actions-setup-docker@master
      - name: Setup Go
        uses: actions/setup-go@v3
        with:
          go-version: ${{ env.GO_VERSION }}
      - name: Setup K8S cluster
        run: |
          GITHUB_USER=${{ secrets.ENV_GITHUB_USER }} GITHUB_PAT=${{ secrets.ENV_GITHUB_PAT }} ./do.sh new_k8s_cluster
      - name: Deploy OTG back-to-back topology with eth0
        run: |
          GITHUB_USER=${{ secrets.ENV_GITHUB_USER }} GITHUB_PAT=${{ secrets.ENV_GITHUB_PAT }} ./do.sh topo new k8seth0
      - name: Setup test prerequisites
        run: |
          ./do.sh pregotest
      - name: Run Go eth0 tests
        run: |
          ./do.sh gotest -tags="all" -run="^TestUdpHeaderEth0$"
      - name: Archive logs
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: kne_b2b_eth0
          path: |
            logs
      - name: Teardown OTG back-to-back topology with eth0
        run: |
          ./do.sh topo rm k8seth0

  lag:
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout source
        uses: actions/checkout@v3
      - name: Setup docker
        uses: docker-practice/actions-setup-docker@master
      - name: Deploy back-to-back LAG CP/DP distribution of ixia-c
        run: |
          GITHUB_USER=${{ secrets.ENV_GITHUB_USER }} GITHUB_PAT=${{ secrets.ENV_GITHUB_PAT }} ./do.sh topo new lag
      - name: Setup Go
        uses: actions/setup-go@v3
        with:
          go-version: ${{ env.GO_VERSION }}
      - name: Setup test prerequisites
        run: |
          ./do.sh pregotest
      - name: Run Go LAG tests
        run: |
          ./do.sh gotest -tags="lag_feature"
      - name: Get container logs
        if: always()
        run: |
          ./do.sh topo logs cpdp
      - name: Archive logs
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: lag
          path: |
            logs
      - name: Teardown back-to-back LAG CP/DP distribution of ixia-c
        run: |
          ./do.sh topo rm lag

  client_perf_py:
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout source
        uses: actions/checkout@v3
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      - name: Setup test prerequisites
        run: |
          ./do.sh prepytest
      - name: Run Python tests
        run: |
          OTG_ITERATIONS=2 ./do.sh pytest -m client_perf
      - name: Archive logs
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: client_perf_py
          path: |
            logs

  client_perf_go:
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout source
        uses: actions/checkout@v3
      - name: Setup Go
        uses: actions/setup-go@v3
        with:
          go-version: ${{ env.GO_VERSION }}
      - name: Setup test prerequisites
        run: |
          ./do.sh pregotest
      - name: Run Go tests
        run: |
          OTG_ITERATIONS=10 ./do.sh gotest -tags=client_perf
      - name: Archive logs
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: client_perf_go
          path: |
            logs

  dp_tput_perf:
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout source
        uses: actions/checkout@v3
      - name: Setup docker
        uses: docker-practice/actions-setup-docker@master
      - name: Deploy back-to-back DP-only distribution of ixia-c
        run: |
          ./do.sh topo new dp
      - name: Setup Go
        uses: actions/setup-go@v3
        with:
          go-version: ${{ env.GO_VERSION }}
      - name: Setup test prerequisites
        run: |
          ./do.sh pregotest
      - name: Run Throughput test
        run: |
          ./do.sh gotest -tags=perf -run "^TestUdpHeaderTputPerf$"
      - name: Get container logs
        if: always()
        run: |
          ./do.sh topo logs dp
      - name: Archive logs
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: dp_tput_perf
          path: |
            logs
      - name: Teardown back-to-back DP-only distribution of ixia-c
        run: |
          ./do.sh topo rm dp

  dp_http_perf:
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout source
        uses: actions/checkout@v3
      - name: Setup docker
        uses: docker-practice/actions-setup-docker@master
      - name: Deploy back-to-back CP/DP distribution of ixia-c
        run: |
          GITHUB_USER=${{ secrets.ENV_GITHUB_USER }} GITHUB_PAT=${{ secrets.ENV_GITHUB_PAT }} ./do.sh topo new cpdp
      - name: Setup Go
        uses: actions/setup-go@v3
        with:
          go-version: ${{ env.GO_VERSION }}
      - name: Setup test prerequisites
        run: |
          ./do.sh pregotest
      - name: Run DP perf test (HTTP)
        run: |
          OTG_ITERATIONS=10 ./do.sh gotest -tags=dp_perf
      - name: Get container logs
        if: always()
        run: |
          ./do.sh topo logs cpdp
      - name: Archive logs
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: dp_http_perf
          path: |
            logs
      - name: Teardown back-to-back CP/DP distribution of ixia-c
        run: |
          ./do.sh topo rm cpdp

  dp_grpc_perf:
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout source
        uses: actions/checkout@v3
      - name: Setup docker
        uses: docker-practice/actions-setup-docker@master
      - name: Deploy back-to-back CP/DP distribution of ixia-c
        run: |
          GITHUB_USER=${{ secrets.ENV_GITHUB_USER }} GITHUB_PAT=${{ secrets.ENV_GITHUB_PAT }} ./do.sh topo new cpdp
      - name: Setup Go
        uses: actions/setup-go@v3
        with:
          go-version: ${{ env.GO_VERSION }}
      - name: Setup test prerequisites
        run: |
          ./do.sh pregotest
      - name: Run DP perf test (gRPC)
        run: |
          OTG_ITERATIONS=10 OTG_GRPC_TRANSPORT=true OTG_HOST="localhost:40051" ./do.sh gotest -tags=dp_perf
      - name: Get container logs
        if: always()
        run: |
          ./do.sh topo logs cpdp
      - name: Archive logs
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: dp_grpc_perf
          path: |
            logs
      - name: Teardown back-to-back CP/DP distribution of ixia-c
        run: |
          ./do.sh topo rm cpdp

  cp_http_perf:
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout source
        uses: actions/checkout@v3
      - name: Setup docker
        uses: docker-practice/actions-setup-docker@master
      - name: Deploy back-to-back CP/DP distribution of ixia-c
        run: |
          GITHUB_USER=${{ secrets.ENV_GITHUB_USER }} GITHUB_PAT=${{ secrets.ENV_GITHUB_PAT }} ./do.sh topo new cpdp
      - name: Setup Go
        uses: actions/setup-go@v3
        with:
          go-version: ${{ env.GO_VERSION }}
      - name: Setup test prerequisites
        run: |
          ./do.sh pregotest
      - name: Run DP perf test (HTTP)
        run: |
          OTG_ITERATIONS=10 ./do.sh gotest -tags=cp_perf
      - name: Get container logs
        if: always()
        run: |
          ./do.sh topo logs cpdp
      - name: Archive logs
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: cp_http_perf
          path: |
            logs
      - name: Teardown back-to-back CP/DP distribution of ixia-c
        run: |
          ./do.sh topo rm cpdp

  cp_grpc_perf:
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout source
        uses: actions/checkout@v3
      - name: Setup docker
        uses: docker-practice/actions-setup-docker@master
      - name: Deploy back-to-back CP/DP distribution of ixia-c
        run: |
          GITHUB_USER=${{ secrets.ENV_GITHUB_USER }} GITHUB_PAT=${{ secrets.ENV_GITHUB_PAT }} ./do.sh topo new cpdp
      - name: Setup Go
        uses: actions/setup-go@v3
        with:
          go-version: ${{ env.GO_VERSION }}
      - name: Setup test prerequisites
        run: |
          ./do.sh pregotest
      - name: Run DP perf test (gRPC)
        run: |
          OTG_ITERATIONS=10 OTG_GRPC_TRANSPORT=true OTG_HOST="localhost:40051" ./do.sh gotest -tags=cp_perf
      - name: Get container logs
        if: always()
        run: |
          ./do.sh topo logs cpdp
      - name: Archive logs
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: cp_grpc_perf
          path: |
            logs
      - name: Teardown back-to-back CP/DP distribution of ixia-c
        run: |
          ./do.sh topo rm cpdp
